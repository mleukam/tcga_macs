---
title: "ssGSEA"
author: "mleukam"
date: "2019-06-09"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Setup

Clear environment
```{r}
# clear environment
rm(list = ls())
```

Load packages
```{r}
library("tidyverse")
library("edgeR")
library("limma")
library("GSVA")
library("GenomicDataCommons")
```

## Gene list preprocessing

Read in custom gene lists
```{r}
up_files <- list.files("output/", "^upreg_c")
down_files <- list.files("output/", "downreg_c")
file_list <- c(up_files, down_files)
path_list <- paste0("output/", file_list)
dge_list <- map(path_list, read_csv)
names(dge_list) <- str_replace_all(file_list, ".csv", "")
```

Read in lookup table for features, gencode v22 (used by GDC to label features)
```{r}
gencode_gtf <- read_tsv("data/gencode.v22.primary_assembly.annotation.gtf.geneinfo")
```


```{r}
# read in T-cell inflammation signature
tcell <- read_tsv("data/160genes_ensembl.gencode28.txt", col_names = FALSE)

# convert to gene_id
gene_ids <- gencode_gtf %>%
  dplyr::select(gene_id, gene_name)
tcell <- tcell %>% dplyr::rename(gene_name = X1)
tcell_gset <- tcell %>% left_join(gene_ids, by = "gene_name") %>%
  pull(gene_id)

tcell_gset <- tcell_gset[!is.na(tcell_gset)]
```

```{r}

# define function that uses lookup table to convert gene symbols to gene id
# then returns a list of gene ids that define the gene set
ensemblgset <- function(df, gtf){
  gene_ids <- gtf %>%
  dplyr::select(gene_id, gene_name) %>%
  dplyr::rename(gene = gene_name)
gset <- df %>% left_join(gene_ids) %>%
  pull(gene_id)
gset
}

# apply function to list of gene sets
gset_ids <- map(dge_list, function(x){ensemblgset(x, gtf = gencode_gtf)})

# remove nas (small number of gene symbols do not map to gencode gene ids)
gset_ids <- map(gset_ids, function(x){
  x[!is.na(x)]
})

# add T-cell signature to gset list
gset_ids_complete <- c(gset_ids, tcell_gset = list(tcell_gset))
  
```

## Count data preprocessing

Preprocessing following methods outlined here: https://f1000research.com/articles/5-1408/v3

Read in data
```{r}
total_counts <- read_csv("output/selected.total.counts.csv")
```

#### Filter for protein coding genes
```{r}

# filter for protein coding genes
total_counts_prcode <- total_counts %>%
  dplyr::rename(gene_id = gene) %>%
  left_join(gencode_gtf, by = "gene_id") %>%
  dplyr::filter(gene_type == "protein_coding") %>%
  dplyr::select(-gene_name, -gene_type, -gene_status, -level, -havana_gene) %>%
  dplyr::select(gene_id, everything())

nrow(total_counts_prcode)

```

#### Correct for library size: convert to CPM
```{r}
# normalize rows by log cpm using EdgeR
df_data <- total_counts_prcode %>% 
  dplyr::select(-gene_id) %>% as.matrix()
df_names <- total_counts_prcode %>% dplyr::select(gene_id) 
out_data <- cpm(df_data, log = FALSE) %>% as_tibble()
total_counts_prcode_cpm <- bind_cols(df_names, out_data)
```

#### Density plots
```{r}
# Density plots
# tidy data
tidy_cpm <- total_counts_prcode_cpm %>% 
  gather(key = "sampleID", value = "intensity", -gene_id) 

tidy_cpm <- tidy_cpm %>%
  mutate(group = str_sub(sampleID, 1, 4))

# representative plots
brca_cpm <- tidy_cpm %>%
  dplyr::filter(group == "BRCA")
dplot_brca <- ggplot(brca_cpm, aes(intensity)) +
  geom_density() + 
  theme(legend.position = "none")
dplot_brca

gbm_cpm <- tidy_cpm %>%
  dplyr::filter(grepl("GBM*", group))
dplot_gbm <- ggplot(gbm_cpm, aes(intensity)) +
  geom_density() + 
  theme(legend.position = "none") +
  xlim(-6, 15)
dplot_gbm
```

#### Filter by expression levels
```{r}
# move gene names to rownames
totcounts_prcode_cpm_matrix <- total_counts_prcode_cpm %>%
  as.data.frame() %>%
  column_to_rownames(var = "gene_id")
totcounts_prcode_cpm_matrix[1:5, 1:5]

# filter out genes that aren't at least expressed greater than 1 in at least 45 cases (45 being about the size of the smallest group)
total_cpm_stats <- data.frame(
  total = apply(totcounts_prcode_cpm_matrix, 1, function(x) sum(x > 1, na.rm = TRUE)))
keep <- which(total_cpm_stats$total >= 45) 

dim(totcounts_prcode_cpm_matrix)
total_cpm_filtered = totcounts_prcode_cpm_matrix[keep,]
dim(total_cpm_filtered)
```

#### Normalize gene expression distributions

Normalisation by the method of trimmed mean of M-values (TMM) is performed using the calcNormFactors function in edgeR. The normalisation factors calculated here are used as a scaling factor for the library sizes. 
```{r}
# get normalization factors
norm_factors <- calcNormFactors(total_cpm_filtered, method = "TMM")

# apply factor to each column
total_cpm_norm <- map2_dfc(total_cpm_filtered, norm_factors, `*`)
total_cpm_norm <- as.data.frame(total_cpm_norm)
rownames(total_cpm_norm) <- rownames(total_cpm_filtered)
total_cpm_norm[1:5, 1:5]
```

#### Log transformation
```{r}
total_log_cpm_filtered_norm <- log2(total_cpm_norm)
```

#### Review representative density plots
```{r}
# Density plots
# tidy data
final_total_df <- total_log_cpm_filtered_norm %>%
  rownames_to_column(var = "gene_id") %>%
  dplyr::select(gene_id, everything())

tidy_norm_cpm <- final_total_df %>% 
  gather(key = "sampleID", value = "intensity", -gene_id) 

tidy_norm_cpm <- tidy_norm_cpm %>%
  mutate(group = str_sub(sampleID, 1, 4))

# representative plots
brca_norm_cpm <- tidy_norm_cpm %>%
  dplyr::filter(group == "BRCA")
dplot_norm_brca <- ggplot(brca_norm_cpm, aes(intensity)) +
  geom_density() + 
  theme(legend.position = "none")
dplot_norm_brca

gbm_norm_cpm <- tidy_norm_cpm %>%
  dplyr::filter(grepl("GBM*", group))
dplot_norm_gbm <- ggplot(gbm_norm_cpm, aes(intensity)) +
  geom_density() + 
  theme(legend.position = "none") +
  xlim(-6, 15)
dplot_norm_gbm
```


## GSVA
Will be done on cluster due to extreme system requirements
Write out matrix and gene set lists for import into stats cluster.
```{r}
# gset list
saveRDS(gset_ids_complete, "output/gset_ids_complete.rds")

expr_matrix <- total_log_cpm_filtered_norm %>% 
  as.data.frame() %>%
  rownames_to_column(var = "gene")

write_csv(expr_matrix, "output/expr_matrix.csv")

```


Get macrophage gene set GSVA scores
```{r eval = FALSE, include = TRUE}

# Run on cluster
# tcga_es <- gsva(expr_matrix, gset_ids_complete,
#                annotation = NULL,
#                method = "gsva",
#                mx.diff = FALSE,
#                verbose = TRUE)

# saveRDS(tcga_es, "/gpfs/data/kline-lab/tcga_macs/tcga_es.rds")
# moved to local hard drive from cluster and stored in output folder

```

## Plots

#### Data cleaning and annotation for plots
```{r}
# read in RDS from cluster, convert to tibble
tcga_es <- readRDS("output/tcga_gsva_17geneset_results.rds") %>% 
  as.data.frame()

tcga_es_tbl <- tcga_es %>% rownames_to_column(var = "gene_set") %>%
  as_tibble()

tcga_es_tidy <- tcga_es_tbl %>% 
  gather(key = "sampleID", value = "score", -gene_set) 

tidy_es <- tcga_es_tidy %>%
  mutate(group = str_sub(sampleID, 1, 4)) %>%
  mutate(group = ifelse(grepl("^GBM*", group), "GBM", group)) %>%
  mutate(group = ifelse(grepl("^OV*", group), "OV", group)) %>%
  mutate(group = ifelse(grepl("^LGG*", group), "LGG", group)) %>%
  mutate(group = ifelse(grepl("^UVM*", group), "UVM", group)) %>%
  mutate(group = ifelse(grepl("^UCS*", group), "UCS", group)) %>%
  mutate(group = ifelse(grepl("^ACC*", group), "ACC", group)) %>%
  mutate(group = as.factor(group))

tidy_es
```

Split metastatic melanoma from primary tumors
Build lookup table that includes clinical data linked to file uuID and filenames
Helper function from Kevin Blighe: https://www.biostars.org/p/318756/#318919
```{r}
# Build a query of HTSeq files availble in GDC from TCGA
qfiles <- files() %>%
  GenomicDataCommons::filter(~ cases.project.project_id == 'TCGA*' & 
                               type == 'gene_expression' & 
                               analysis.workflow_type =='HTSeq - Counts')

# get a table of filenames and ids from the query
total_manifest <- manifest(qfiles)

# read in helper function
TCGAtranslateID = function(file_names, legacy = TRUE)
{
  info = files(legacy = legacy) %>%
    GenomicDataCommons::filter( ~ file_name %in% file_names) %>%
    GenomicDataCommons::select('cases.samples.submitter_id') %>%
    results_all()

  id_list = lapply(info$cases,function(a)
  {
    a[[1]][[1]][[1]]
  })

    barcodes_per_file = sapply(id_list,length)

    return(data.frame(file_id=rep(ids(info),barcodes_per_file), submitter_id=unlist(id_list), file_names=file_names))
}

file_table <- TCGAtranslateID(total_manifest$filename, legacy = FALSE) 
file_table <- as_tibble(file_table)

# read in kyle's TCGA metadata table
kyle_table <- read_tsv("data/kyle.gdc_tcga_bam_metadata.txt")
kyle_table <- kyle_table %>% 
  dplyr::rename(submitter_id = cases_0_samples_0_submitter_id) %>%
  dplyr::select(-file_id)

lookup_table <- file_table %>% 
  left_join(kyle_table, by = "submitter_id") %>% 
  dplyr::select(submitter_id, 
                file_id, 
                project_id = cases_0_project_project_id, 
                sample_type = cases_0_samples_0_sample_type,
                everything()) %>%
  dplyr::select(-data_type, 
                -file_name, 
                -data_category, 
                -analysis_workflow_type)
```

Add sample names to lookup table and regroup melanoma
```{r}
# read in pheno data linked to my sample names
pheno_data <- read_csv("output/filtered.total.phenodata.csv")

pheno_joined <- pheno_data %>%
  left_join(lookup_table) %>%
  print()

summary(as.factor(pheno_data$project_id))

pheno_joined %>% 
  dplyr::filter(project_id == "TCGA-SKCM") %>% 
  mutate(sample_type = as.factor(sample_type)) %>%
  dplyr::select(sample_type) %>%
  summary()

metastatic_vector <- pheno_joined %>% 
  dplyr::filter(project_id == "TCGA-SKCM",
                sample_type == "Metastatic") %>% 
  pull(sample) %>%
  print()

primary_vector <- pheno_joined %>% 
  dplyr::filter(project_id == "TCGA-SKCM",
                sample_type == "Primary Tumor") %>% 
  pull(sample) %>%
  print()

tidy_es_cleaned <- tidy_es %>%
  mutate(group = as.character(group)) %>%
  mutate(group = ifelse(sampleID %in% metastatic_vector, "SKCM_MET", group)) %>%
  mutate(group = ifelse(sampleID %in% primary_vector, "SKCM_PRI", group)) %>%
  mutate(group = as.factor(group)) 
summary(tidy_es_cleaned$group)
           
```

#### Beeswarm plots 
```{r}
library(ggsci)
library(ggpubr)
library(ggbeeswarm)

tidy_es_c1 <- tidy_es_cleaned %>% dplyr::filter(gene_set == "upreg_c1")
c1plot <- ggplot(tidy_es_c1,
       aes(x = fct_reorder(group, score, mean), y = score)) + 
  geom_quasirandom(alpha = 0.2) +
  scale_fill_igv() + 
  stat_summary(fun.y = mean, fun.ymin = mean, fun.ymax = mean,
                 geom = "crossbar", width = 0.5, color = "red") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab("TGCA tumor type") +
  ylab("GSVA enrichment score") +
  ggtitle("Macrophage Cluster 1: \"Alternate activation (M2)\"") +
  geom_hline(yintercept = 0, linetype = "dashed")
c1plot

tidy_es_c2 <- tidy_es_cleaned %>% dplyr::filter(gene_set == "upreg_c2")
c2plot <- ggplot(tidy_es_c2,
       aes(x = fct_reorder(group, score, mean), y = score)) + 
  geom_quasirandom(alpha = 0.2) +
  scale_fill_igv() + 
  stat_summary(fun.y = mean, fun.ymin = mean, fun.ymax = mean,
                 geom = "crossbar", width = 0.5, color = "red") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab("TGCA tumor type") +
  ylab("GSVA enrichment score") +
  ggtitle("Macrophage Cluster 2: \"Classical activation (M1)\"") +
  geom_hline(yintercept = 0, linetype = "dashed")
c2plot

tidy_es_c3 <- tidy_es_cleaned %>% dplyr::filter(gene_set == "upreg_c3")
c3plot <- ggplot(tidy_es_c3,
       aes(x = fct_reorder(group, score, mean), y = score)) + 
  geom_quasirandom(alpha = 0.2) +
  scale_fill_igv() + 
  stat_summary(fun.y = mean, fun.ymin = mean, fun.ymax = mean,
                 geom = "crossbar", width = 0.5, color = "red") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab("TGCA tumor type") +
  ylab("GSVA enrichment score") +
  ggtitle("Macrophage Cluster 3: \"Deactivated macrophages\"") +
  geom_hline(yintercept = 0, linetype = "dashed")
c3plot

tidy_es_c4 <- tidy_es_cleaned %>% dplyr::filter(gene_set == "upreg_c4")
c4plot <- ggplot(tidy_es_c4,
       aes(x = fct_reorder(group, score, mean), y = score)) + 
  geom_quasirandom(alpha = 0.2) +
  scale_fill_igv() + 
  stat_summary(fun.y = mean, fun.ymin = mean, fun.ymax = mean,
                 geom = "crossbar", width = 0.5, color = "red") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab("TGCA tumor type") +
  ylab("GSVA enrichment score") +
  ggtitle("Macrophage Cluster 4 \"Acute inflammation/migration\"") +
  geom_hline(yintercept = 0, linetype = "dashed")
c4plot

tidy_es_c5 <- tidy_es_cleaned %>% dplyr::filter(gene_set == "upreg_c5")
c5plot <- ggplot(tidy_es_c5,
       aes(x = fct_reorder(group, score, mean), y = score)) + 
  geom_quasirandom(alpha = 0.2) +
  scale_fill_igv() + 
  stat_summary(fun.y = mean, fun.ymin = mean, fun.ymax = mean,
                 geom = "crossbar", width = 0.5, color = "red") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab("TGCA tumor type") +
  ylab("GSVA enrichment score") +
  ggtitle("Macrophage Cluster 5: \"Chronic wound\"") +
  geom_hline(yintercept = 0, linetype = "dashed")
c5plot

tidy_es_c6 <- tidy_es_cleaned %>% dplyr::filter(gene_set == "upreg_c6")
c6plot <- ggplot(tidy_es_c6,
       aes(x = fct_reorder(group, score, mean), y = score)) + 
  geom_quasirandom(alpha = 0.2) +
  scale_fill_igv() + 
  stat_summary(fun.y = mean, fun.ymin = mean, fun.ymax = mean,
                 geom = "crossbar", width = 0.5, color = "red") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab("TGCA tumor type") +
  ylab("GSVA enrichment score") +
  ggtitle("Macrophage Cluster 6: \"Immunosuppresive macrophages\"") +
  geom_hline(yintercept = 0, linetype = "dashed")
c6plot

tidy_es_c7 <- tidy_es_cleaned %>% dplyr::filter(gene_set == "upreg_c7")
c7plot <- ggplot(tidy_es_c7,
       aes(x = fct_reorder(group, score, mean), y = score)) + 
  geom_quasirandom(alpha = 0.2) +
  scale_fill_igv() + 
  stat_summary(fun.y = mean, fun.ymin = mean, fun.ymax = mean,
                 geom = "crossbar", width = 0.5, color = "red") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab("TGCA tumor type") +
  ylab("GSVA enrichment score") +
  ggtitle("Macrophage Cluster 7: \"Mixed immune response\"") +
  geom_hline(yintercept = 0, linetype = "dashed")
c7plot

tidy_es_t <- tidy_es_cleaned %>% dplyr::filter(gene_set == "tcell_gset")
tplot <- ggplot(tidy_es_t,
       aes(x = fct_reorder(group, score, mean), y = score)) + 
  geom_quasirandom(alpha = 0.2) +
  scale_fill_igv() + 
  stat_summary(fun.y = mean, fun.ymin = mean, fun.ymax = mean,
                 geom = "crossbar", width = 0.5, color = "red") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab("TGCA tumor type") +
  ylab("GSVA enrichment score") +
  ggtitle("T cell activation gene set") +
  geom_hline(yintercept = 0, linetype = "dashed")
tplot
```

Downregulated gene sets
```{r}
tidy_es_c1d <- tidy_es_cleaned %>% dplyr::filter(gene_set == "downreg_c1")
c1dplot <- ggplot(tidy_es_c1d,
       aes(x = fct_reorder(group, score, mean), y = score)) + 
  geom_quasirandom(alpha = 0.2) +
  scale_fill_igv() + 
  stat_summary(fun.y = mean, fun.ymin = mean, fun.ymax = mean,
                 geom = "crossbar", width = 0.5, color = "red") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab("TGCA tumor type") +
  ylab("GSVA enrichment score") +
  ggtitle("Macrophage Cluster 1: \"Alternate activation (M2)\"") +
  geom_hline(yintercept = 0, linetype = "dashed")
c1dplot

tidy_es_c2d <- tidy_es_cleaned %>% dplyr::filter(gene_set == "downreg_c2")
c2dplot <- ggplot(tidy_es_c2d,
       aes(x = fct_reorder(group, score, mean), y = score)) + 
  geom_quasirandom(alpha = 0.2) +
  scale_fill_igv() + 
  stat_summary(fun.y = mean, fun.ymin = mean, fun.ymax = mean,
                 geom = "crossbar", width = 0.5, color = "red") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab("TGCA tumor type") +
  ylab("GSVA enrichment score") +
  ggtitle("Macrophage Cluster 2: \"Classical activation (M1)\"") +
  geom_hline(yintercept = 0, linetype = "dashed")
c2dplot

tidy_es_c3d <- tidy_es_cleaned %>% dplyr::filter(gene_set == "downreg_c3")
c3dplot <- ggplot(tidy_es_c3d,
       aes(x = fct_reorder(group, score, mean), y = score)) + 
  geom_quasirandom(alpha = 0.2) +
  scale_fill_igv() + 
  stat_summary(fun.y = mean, fun.ymin = mean, fun.ymax = mean,
                 geom = "crossbar", width = 0.5, color = "red") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab("TGCA tumor type") +
  ylab("GSVA enrichment score") +
  ggtitle("Macrophage Cluster 3: \"Deactivated macrophages\"") +
  geom_hline(yintercept = 0, linetype = "dashed")
c3dplot

tidy_es_c4d <- tidy_es_cleaned %>% dplyr::filter(gene_set == "downreg_c4")
c4dplot <- ggplot(tidy_es_c4d,
       aes(x = fct_reorder(group, score, mean), y = score)) + 
  geom_quasirandom(alpha = 0.2) +
  scale_fill_igv() + 
  stat_summary(fun.y = mean, fun.ymin = mean, fun.ymax = mean,
                 geom = "crossbar", width = 0.5, color = "red") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab("TGCA tumor type") +
  ylab("GSVA enrichment score") +
  ggtitle("Macrophage Cluster 4 \"Acute inflammation/migration\"") +
  geom_hline(yintercept = 0, linetype = "dashed")
c4dplot

tidy_es_c5d <- tidy_es_cleaned %>% dplyr::filter(gene_set == "downreg_c5")
c5dplot <- ggplot(tidy_es_c5d,
       aes(x = fct_reorder(group, score, mean), y = score)) + 
  geom_quasirandom(alpha = 0.2) +
  scale_fill_igv() + 
  stat_summary(fun.y = mean, fun.ymin = mean, fun.ymax = mean,
                 geom = "crossbar", width = 0.5, color = "red") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab("TGCA tumor type") +
  ylab("GSVA enrichment score") +
  ggtitle("Macrophage Cluster 5: \"Chronic wound\"") +
  geom_hline(yintercept = 0, linetype = "dashed")
c5dplot

tidy_es_c6d <- tidy_es_cleaned %>% dplyr::filter(gene_set == "downreg_c6")
c6dplot <- ggplot(tidy_es_c6d,
       aes(x = fct_reorder(group, score, mean), y = score)) + 
  geom_quasirandom(alpha = 0.2) +
  scale_fill_igv() + 
  stat_summary(fun.y = mean, fun.ymin = mean, fun.ymax = mean,
                 geom = "crossbar", width = 0.5, color = "red") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab("TGCA tumor type") +
  ylab("GSVA enrichment score") +
  ggtitle("Macrophage Cluster 6: \"Immunosuppresive macrophages\"") +
  geom_hline(yintercept = 0, linetype = "dashed")
c6dplot

tidy_es_c7d <- tidy_es_cleaned %>% dplyr::filter(gene_set == "downreg_c7")
c7dplot <- ggplot(tidy_es_c7d,
       aes(x = fct_reorder(group, score, mean), y = score)) + 
  geom_quasirandom(alpha = 0.2) +
  scale_fill_igv() + 
  stat_summary(fun.y = mean, fun.ymin = mean, fun.ymax = mean,
                 geom = "crossbar", width = 0.5, color = "red") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab("TGCA tumor type") +
  ylab("GSVA enrichment score") +
  ggtitle("Macrophage Cluster 7: \"Mixed immune response\"") +
  geom_hline(yintercept = 0, linetype = "dashed")
c7dplot

tidy_es_t <- tidy_es_cleaned %>% dplyr::filter(gene_set == "tcell_gset")
tplot <- ggplot(tidy_es_t,
       aes(x = fct_reorder(group, score, mean), y = score)) + 
  geom_quasirandom(alpha = 0.2) +
  scale_fill_igv() + 
  stat_summary(fun.y = mean, fun.ymin = mean, fun.ymax = mean,
                 geom = "crossbar", width = 0.5, color = "red") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab("TGCA tumor type") +
  ylab("GSVA enrichment score") +
  ggtitle("T cell activation gene set") +
  geom_hline(yintercept = 0, linetype = "dashed")
tplot
```


Annotate combined figure source: https://rpkgs.datanovia.com/ggpubr/reference/annotate_figure.html

ggpubr tutorial: http://www.sthda.com/english/articles/24-ggpubr-publication-ready-plots/


```{r fig.height=12, fig.width=12}
combined_up_plot <- ggarrange(c1plot, c2plot, c3plot, c4plot, c5plot, c6plot, c7plot, tplot,
          labels = c("A", "B", "C", "D", "E", "F", "G", "H"),
          ncol = 2, nrow = 4)

combined_up_plot <- annotate_figure(combined_up_plot,
                top = text_grob("Enrichment scores for upregulated genes in macrophage clusters", 
                                color = "black", 
                                face = "bold", 
                                size = 14))

combined_up_plot

combined_down_plot <- ggarrange(c1dplot, c2dplot, c3dplot, c4dplot, c5dplot, c6dplot, c7dplot, tplot,
          labels = c("A", "B", "C", "D", "E", "F", "G", "H"),
          ncol = 2, nrow = 4)

combined_down_plot <- annotate_figure(combined_down_plot,
                top = text_grob("Enrichment scores for downregulated genes in macrophage clusters", 
                                color = "black", 
                                face = "bold", 
                                size = 14))

combined_down_plot

```

#### Box plots

```{r}
# iterate over list of groups
# get list of groups
grouplist <- summary(tidy_es_cleaned$group) %>% 
  enframe() %>%
  dplyr::select(name)
grouplist <- as.list(c(grouplist$name))
grouplist

# define function
boxplotter <- function(grouplist){
  df <- tidy_es_cleaned %>%
    dplyr::filter(group == grouplist) %>%
    mutate(gene_set = as.factor(gene_set)) %>%
    mutate(gene_set = fct_recode(gene_set, 
                                 "T-cell inflamed" = "tcell_gset",
                                 "C1 upregulated" = "upreg_c1", 
                                 "C1 downregulated" = "downreg_c1",
                                 "C2 upregulated" = "upreg_c2",
                                 "C2 downregulated" = "downreg_c2",
                                 "C3 upregulated" = "upreg_c3",
                                 "C3 downregulated" = "downreg_c3",
                                 "C4 upregulated" = "upreg_c4",
                                 "C4 downregulated" = "downreg_c4",
                                 "C5 upregulated" = "upreg_c5",
                                 "C5 downregulated" = "downreg_c5",
                                 "C6 upregulated" = "upreg_c6",
                                 "C6 downregulated" = "downreg_c6",
                                 "C7 upregulated" = "upreg_c7",
                                 "C7 downregulated" = "downreg_c7")) %>%
    mutate(gene_set = fct_relevel(gene_set, c("T-cell inflamed", 
                                            "C1 upregulated", 
                                            "C1 downregulated", 
                                            "C2 upregulated", 
                                            "C2 downregulated", 
                                            "C3 upregulated", 
                                            "C3 downregulated", 
                                            "C4 upregulated", 
                                            "C4 downregulated", 
                                            "C5 upregulated", 
                                            "C5 downregulated", 
                                            "C6 upregulated", 
                                            "C6 downregulated", 
                                            "C7 upregulated", 
                                            "C7 downregulated"))) %>%
    mutate(cluster = str_sub(gene_set, 1, 2)) %>%
    mutate(cluster = ifelse(cluster == "T-", "T", cluster)) %>%
    group_by(gene_set) %>%
    mutate(up_down = ifelse(gene_set == "T-cell inflamed", "upregulated", 
                          ifelse(grepl("upregulated", gene_set), "upregulated",
                                 ifelse(grepl("downregulated", gene_set), "downregulated", NA))))
  boxplot <- ggplot(df, aes(y = score, x = cluster, fill = up_down)) +
    geom_boxplot(alpha = 0.8) +
    geom_hline(yintercept = 0, linetype = "dashed") +
    labs(fill = "Gene Set Type") +
    scale_fill_igv() +
    theme_classic2() +
    ggtitle(paste0("GVSA scores for ", grouplist)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1))
  boxplot
}

# map function to group list to get plots
boxplots <- map(grouplist, boxplotter)
names(boxplots) <- grouplist
list2env(boxplots, env = environment())
```

Combine plots into a single plot
```{r fig.height=16, fig.width=16}
combined_boxplot <- ggarrange(ACC, BLCA, BRCA, CESC, CHOL, COAD, ESCA, GBM, HNSC,KICH, KIRC, KIRP, LGG, LIHC, LUAD, LUSC, MESO, OV, PAAD, PCPG, PRAD, READ, SARC, SKCM_MET, SKCM_PRI, STAD, TGCT, THCA, UCS, UVM, 
                              ncol = 5, 
                              nrow = 6,
                              common.legend = TRUE,
                              legend = "bottom")
combined_boxplot
```
